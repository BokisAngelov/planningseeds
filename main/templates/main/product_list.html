{% extends 'main.html' %}

{% block content %}
<h1 class="uk-margin-medium uk-margin-medium-top">Products</h1>

<div class="uk-container">
    <div class="uk-grid-small" id="sticky-div" uk-grid>
        <div class="uk-width-1-3">
            <a class="uk-button uk-button-primary uk-margin" href="{% url 'products-list' %}">Reset Filters</a>
            <div class="uk-card uk-padding-remove-left">
                <div class="uk-card-header uk-padding-remove-left uk-padding-remove-bottom">
                    <h3 class="uk-card-title">Categories</h3>
                </div>
                <div class="uk-card-body uk-padding-remove-left uk-padding-remove-top uk-margin-top">
                    <form id="category-form">
                        {% for category in categories %}
                            <label style="display: block;" class="uk-margin ">
                                <input type="checkbox" class="category-checkbox uk-checkbox" name="category" value="{{ category.id }}" />
                                {{ category.name }}
                            </label>
                        {% endfor %}
                    </form>
                </div>
            </div>
            <hr>
            <div class="uk-card uk-padding-remove-left">
                <div class="uk-card-header uk-padding-remove-left uk-padding-remove-bottom">
                    <h3 class="uk-card-title">Countries</h3>
                </div>
                <div class="uk-card-body uk-padding-remove-left uk-padding-remove-top uk-margin-top">
                    <form id="country-form">
                        {% for country in countries %}
                            {% if country == None %}
                            {% else %}
                            <label style="display: block;" class="uk-margin ">
                                <input type="checkbox" class="country-checkbox uk-checkbox" name="country" value="{{ country }}" />
                                {{ country }}
                            </label>
                            {% endif %}
                        {% endfor %}
                    </form>
                    
                </div>
            </div>
        </div>

        <div class="uk-width-2-3">
            <div id="product-list" class="uk-child-width-1-2 uk-grid uk-grid-match" uk-grid>
                {% include 'main/product_filter_grid.html' %}
            </div>
        </div>
    </div>

</div>
<script>
    $(document).ready(function(){

        function applyFilters(){
            // Gather selected categories
            let selectedCategories = [];
            $('.category-checkbox:checked').each(function() {
                selectedCategories.push($(this).val());
            });

            let selectedCountries = [];
            $('.country-checkbox:checked').each(function() {
                selectedCountries.push($(this).val());
            });

            // Send AJAX request with filters
            $.ajax({
                url: "{% url 'filter_products' %}",
                data: {
                    categories: selectedCategories,
                    countries: selectedCountries
                },
                traditional: true,  // Ensures arrays are sent correctly
                success: function(response) {
                    $('#product-list').html(response.html);
                }
            });
        }

        // Trigger filtering
        $(document).on('change', '.category-checkbox, .country-checkbox', applyFilters);
        
    });

</script>

{% endblock content %}

